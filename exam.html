<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exam | Bothverse Academy</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .top-bar { display: flex; justify-content: space-between; align-items: center; padding: 15px; background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        #timer { font-size: 1.4rem; color: #ef4444; font-weight: bold; background: #fee2e2; padding: 5px 15px; border-radius: 20px; }
        .option-card { display: block; margin: 10px 0; padding: 15px; border: 2px solid #e2e8f0; border-radius: 12px; cursor: pointer; text-align: left; }
        .option-card:hover { background: #f8fafc; border-color: #6366f1; }
    </style>
</head>
<body class="light">

<div class="top-bar">
    <div><b id="student"></b> <button onclick="confirmExit()" style="background:red; color:white; border:none; padding:5px 10px; border-radius:5px; cursor:pointer;">Exit</button></div>
    <span id="timer">00:00</span>
</div>

<div class="login-box" style="max-width:700px; margin:30px auto; padding:25px;">
    <div style="display:flex; justify-content:space-between; margin-bottom:10px; color:#64748b;">
        <span id="q-count">Question 0/0</span>
        <span id="tab-warnings" style="color:orange; font-weight:bold;"></span>
    </div>
    <h2 id="question">Loading...</h2>
    <div id="options-container"></div>
    <div style="display:flex; gap:10px; margin-top:20px;">
        <button id="prev-btn" onclick="prevQuestion()" style="flex:1; padding:12px; background:#64748b; color:white; border-radius:8px; display:none;">Previous</button>
        <button id="next-btn" onclick="nextQuestion()" style="flex:2; padding:12px; background:#6366f1; color:white; border-radius:8px; display:none;">Next Question</button>
    </div>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbxpZqNd0_-AHxm3eIPNemMpp3oNawmWxt4nryDzE9UmkxWRDHcpXfOXt_4ABqSP1wJywg/exec";

// SECURITY: Anti-Cheat
document.addEventListener('contextmenu', e => e.preventDefault());
document.onkeydown = e => { if(e.keyCode == 123 || (e.ctrlKey && e.shiftKey && e.keyCode == 73)) return false; };

let tabWarnings = 0;
window.onblur = () => {
    tabWarnings++;
    document.getElementById("tab-warnings").innerText = `⚠️ Warnings: ${tabWarnings}/3`;
    if(tabWarnings >= 3) finish(); else alert("Warning: Don't switch tabs!");
};

// DATA HANDLING (Aapka Purana Logic)
const name = localStorage.getItem("studentName") || "Guest";
const cls = localStorage.getItem("studentClass") || "-";
const savedTime = localStorage.getItem("examTime") || "5";
const limit = { 5: 20, 10: 40, 15: 60, 20: 80 }[savedTime] || 20;

document.getElementById("student").innerText = `${name} | ${cls}`;

let questions = [];
let userChoices = [];
let index = 0;

// FETCH: Action 'getTest' ka use
fetch(`${API_URL}?action=getTest&className=${encodeURIComponent(cls)}`)
.then(res => res.json())
.then(data => {
    if(data.error) return document.getElementById("question").innerText = "❌ No Test Found!";
    
    data.shift(); // Headers hatao
    questions = data.map(r => ({
        question: r[0],
        a: r[1].split('|')[0] || r[1],
        b: r[1].split('|')[1] || "",
        c: r[1].split('|')[2] || "",
        d: r[1].split('|')[3] || "",
        correct: r[2] // Browser scoring ke liye
    })).sort(() => Math.random() - 0.5).slice(0, limit);

    document.getElementById("next-btn").style.display = "block";
    loadQuestion();
    startTimer();
});

function loadQuestion() {
    const q = questions[index];
    document.getElementById("q-count").innerText = `Q ${index+1} / ${questions.length}`;
    document.getElementById("question").innerText = q.question;
    const container = document.getElementById("options-container");
    container.innerHTML = "";

    ["a","b","c","d"].forEach(opt => {
        const saved = userChoices[index] && userChoices[index].selected === opt;
        container.innerHTML += `<label class="option-card"><input type="radio" name="opt" value="${opt}" ${saved ? 'checked' : ''} style="margin-right:10px;"> ${q[opt]}</label>`;
    });
    document.getElementById("prev-btn").style.display = index === 0 ? "none" : "block";
    document.getElementById("next-btn").innerText = index === questions.length - 1 ? "Submit Exam" : "Next Question";
}

function nextQuestion() {
    const sel = document.querySelector("input[name='opt']:checked");
    if (!sel) return alert("Select an answer!");
    
    userChoices[index] = { 
        question: questions[index].question, 
        selected: sel.value, 
        correct: questions[index].correct,
        options: { a: questions[index].a, b: questions[index].b, c: questions[index].c, d: questions[index].d } 
    };

    if (index < questions.length - 1) { index++; loadQuestion(); } else { if(confirm("Submit?")) finish(); }
}

function prevQuestion() { if(index > 0) { index--; loadQuestion(); } }

function finish() {
    localStorage.setItem("reviewData", JSON.stringify(userChoices));
    window.location.href = "result.html";
}

function startTimer() {
    let sec = parseInt(savedTime) * 60;
    const itv = setInterval(() => {
        let m = Math.floor(sec/60), s = sec%60;
        document.getElementById("timer").innerText = `${m}:${s < 10 ? '0'+s : s}`;
        if (sec-- <= 0) { clearInterval(itv); finish(); }
    }, 1000);
}

function confirmExit() { if(confirm("Exit?")) window.location.href='index.html'; }
</script>
</body>
</html>

