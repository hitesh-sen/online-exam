<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Online Exam Portal | Bothverse Academy</title>
<link rel="stylesheet" href="style.css">
<style>
  /* 1. HOVER FIX: Text nazar aana chahiye */
  .option-card { 
      display:block; margin:10px 0; padding:12px; border:1px solid #ccc; 
      border-radius:8px; cursor:pointer; text-align:left; transition: 0.2s;
      background: #1e293b; color: white; /* Dark theme jaisa screenshot mein hai */
  }
  .option-card:hover { 
      background: #334155 !important; /* Thoda light grey, white nahi! */
      border-color: #22c55e !important;
  }
  #tab-warning-ui { color: #f59e0b; font-weight: bold; font-size: 0.9rem; margin-bottom: 5px; display: block; text-align: center; }
  
  /* Loading state ke liye buttons hide rakhna */
  .hidden { display: none !important; }
</style>
</head>

<body class="light">

<div class="top-bar" style="background: #22c55e; color: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center;">
  <div>
    <b id="student"></b>
    <button onclick="location.href='index.html'" style="padding:5px 12px; background:red; color:white; border:none; border-radius:5px; cursor:pointer; font-weight:bold; margin-left:10px;">Exit</button>
  </div>
  <span id="timer" style="font-weight:bold;">00:00</span>
</div>

<div class="login-box" style="max-width:600px; margin:40px auto; padding: 25px; background: #0f172a; border-radius: 15px;">
  <span id="tab-warning-ui"></span>
  <h2 id="question" style="color: white; text-align: center; font-size: 1.4rem;">Loading Questions...</h2>
  <div id="options-container"></div>

  <button id="prev-btn" onclick="prevQuestion()" class="hidden"
    style="width:100%; padding:12px; background:#475569; color:white; border:none; border-radius:8px; font-weight:bold; cursor:pointer; margin-bottom:10px;">
    Previous Question
  </button>

  <button id="next-btn" onclick="nextQuestion()" class="hidden"
    style="width:100%; padding:12px; background:#22c55e; color:white; border:none; border-radius:8px; font-weight:bold; cursor:pointer;">
    Next Question
  </button>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbwTMB_a1P1s9ukPenPvPxVFF2ZFtyyNN0M0sPe_7FovXpNkzd7yv18LsfZeQ0Y7yN6z4A/exec";

// --- SECURITY LOGIC (Fixed for Submit) ---
let warnings = 0;
let isSubmitting = false; // Flag to stop alerts during submission

window.onblur = () => {
    if(isSubmitting) return; // Agar submit ho raha hai toh alert mat dikhao
    warnings++;
    document.getElementById("tab-warning-ui").innerText = `⚠️ Tab Switches: ${warnings}/3`;
    if(warnings >= 3) { finish(); }
    else { alert("Warning: Do not switch tabs!"); }
};

const savedTime = localStorage.getItem("examTime") || "5";
const time = parseInt(savedTime);
const name = localStorage.getItem("studentName") || "Guest";
const cls = localStorage.getItem("studentClass") || "-";
document.getElementById("student").innerText = `${name} | ${cls}`;

const limitMapping = { 5: 20, 10: 40, 15: 60, 20: 80 };
const limit = limitMapping[time] || 20;

let questions = [];
let userChoices = [];
let index = 0;

fetch(API_URL)
.then(res => res.json())
.then(data => {
  questions = data.sort(() => Math.random() - 0.5).slice(0, limit);
  // Questions load hone ke baad hi buttons dikhao
  document.getElementById("next-btn").classList.remove("hidden");
  loadQuestion();
  startTimer();
});

function loadQuestion() {
  const q = questions[index];
  document.getElementById("question").innerText = `Q${index+1}. ${q.question}`;
  const container = document.getElementById("options-container");
  container.innerHTML = "";

  ["a","b","c","d"].forEach(opt => {
    container.innerHTML += `
      <label class="option-card">
        <input type="radio" name="opt" value="${opt}" style="margin-right:10px;">
        ${q[opt]}
      </label>`;
  });

  if (userChoices[index]) {
    const radio = document.querySelector(`input[value="${userChoices[index].selected}"]`);
    if (radio) radio.checked = true;
  }

  // 2. PREVIOUS BUTTON FIX: Index 0 par hide rakho
  const prevBtn = document.getElementById("prev-btn");
  if (index === 0) prevBtn.classList.add("hidden");
  else prevBtn.classList.remove("hidden");

  document.getElementById("next-btn").innerText =
    index === questions.length - 1 ? "Submit Exam" : "Next Question";
}

function nextQuestion() {
  const sel = document.querySelector("input[name='opt']:checked");
  if (!sel) return alert("Please select an answer!");

  userChoices[index] = {
    question: questions[index].question,
    selected: sel.value,
    correct: questions[index].correct,
    options: { a: questions[index].a, b: questions[index].b, c: questions[index].c, d: questions[index].d }
  };

  if (index < questions.length - 1) {
    index++;
    loadQuestion();
  } else {
    // 3. SUBMIT FIX: Confirmation se pehle flag on karo
    isSubmitting = true; 
    if(confirm("Are you sure you want to submit the exam?")) {
        finish();
    } else {
        isSubmitting = false; // Agar cancel kiya toh wapas security on
    }
  }
}

function prevQuestion() {
  if (index > 0) { index--; loadQuestion(); }
}

function finish() {
  isSubmitting = true; 
  localStorage.setItem("reviewData", JSON.stringify(userChoices));
  window.location.href = "result.html";
}

function startTimer() {
  let sec = time * 60;
  const timerInt = setInterval(() => {
    let m = Math.floor(sec / 60);
    let s = sec % 60;
    document.getElementById("timer").innerText = `${m}:${s < 10 ? "0"+s : s}`;
    if (sec-- <= 0) { clearInterval(timerInt); finish(); }
  }, 1000);
}
</script>
</body>
</html>
